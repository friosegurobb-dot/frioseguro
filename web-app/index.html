<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FrioSeguro - Monitoreo de Temperatura</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ùÑÔ∏è</text></svg>">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FrioSeguro">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: rgba(30, 41, 59, 0.8);
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --accent-blue: #3b82f6;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --accent-yellow: #eab308;
      --accent-purple: #8b5cf6;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1a2e 50%, var(--bg-secondary) 100%);
      min-height: 100vh;
      color: var(--text-primary);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 30px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      font-size: 2.5em;
    }
    
    .logo h1 {
      font-size: 1.8em;
      font-weight: 700;
    }
    
    .logo h1 span {
      color: var(--accent-blue);
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-card);
      border-radius: 20px;
      font-size: 0.9em;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-red);
      animation: pulse 2s infinite;
    }
    
    .status-dot.online {
      background: var(--accent-green);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Alert Banner */
    .alert-banner {
      background: linear-gradient(90deg, var(--accent-red), #dc2626);
      padding: 16px 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: none;
      animation: alertPulse 1s infinite;
    }
    
    .alert-banner.active {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .alert-banner h3 {
      font-size: 1.2em;
    }
    
    .alert-banner button {
      background: white;
      color: var(--accent-red);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    @keyframes alertPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .stat-card .label {
      color: var(--text-secondary);
      font-size: 0.85em;
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      font-size: 2em;
      font-weight: 700;
    }
    
    .stat-card .value.temp { color: var(--accent-blue); }
    .stat-card .value.ok { color: var(--accent-green); }
    .stat-card .value.warning { color: var(--accent-yellow); }
    .stat-card .value.critical { color: var(--accent-red); }
    
    /* Devices Grid */
    .section-title {
      font-size: 1.4em;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .devices-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
      margin-bottom: 30px;
    }
    
    .device-card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .device-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .device-card.alert {
      border-color: var(--accent-red);
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
    }
    
    .device-card.offline {
      opacity: 0.6;
    }
    
    .device-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    
    .device-name {
      font-size: 1.3em;
      font-weight: 600;
    }
    
    .device-location {
      color: var(--text-secondary);
      font-size: 0.9em;
      margin-top: 4px;
    }
    
    .device-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
    }
    
    .device-status.online {
      background: rgba(34, 197, 94, 0.2);
      color: var(--accent-green);
    }
    
    .device-status.offline {
      background: rgba(239, 68, 68, 0.2);
      color: var(--accent-red);
    }
    
    .device-status.simulation {
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent-purple);
    }
    
    .device-temp {
      text-align: center;
      padding: 20px 0;
      border-top: 1px solid rgba(255,255,255,0.1);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }
    
    .device-temp .temp-value {
      font-size: 3.5em;
      font-weight: 700;
      color: var(--accent-blue);
    }
    
    .device-temp .temp-value.warning {
      color: var(--accent-yellow);
    }
    
    .device-temp .temp-value.critical {
      color: var(--accent-red);
    }
    
    .device-temp .temp-label {
      color: var(--text-secondary);
      font-size: 0.9em;
      margin-top: 4px;
    }
    
    .device-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .info-item {
      background: rgba(0,0,0,0.2);
      padding: 12px;
      border-radius: 10px;
    }
    
    .info-item .label {
      color: var(--text-secondary);
      font-size: 0.8em;
      margin-bottom: 4px;
    }
    
    .info-item .value {
      font-weight: 600;
    }
    
    .info-item .value.open {
      color: var(--accent-yellow);
    }
    
    .info-item .value.closed {
      color: var(--accent-green);
    }
    
    .device-actions {
      margin-top: 16px;
      display: flex;
      gap: 10px;
    }
    
    .device-actions button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .device-actions button:hover {
      transform: scale(1.02);
    }
    
    .btn-stop {
      background: var(--accent-green);
      color: white;
    }
    
    .btn-details {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    /* No devices */
    .no-devices {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    .no-devices .icon {
      font-size: 4em;
      margin-bottom: 20px;
    }
    
    /* Footer */
    footer {
      text-align: center;
      padding: 30px;
      color: var(--text-secondary);
      font-size: 0.9em;
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: 40px;
    }
    
    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 60px;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.1);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .devices-grid {
        grid-template-columns: 1fr;
      }
      
      header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <span class="logo-icon">‚ùÑÔ∏è</span>
        <h1>Frio<span>Seguro</span></h1>
      </div>
      <div style="display:flex;gap:12px;align-items:center;">
        <select id="orgSelector" onchange="changeOrg()" style="padding:8px 16px;border-radius:10px;background:#1e293b;color:white;border:1px solid #334155;font-size:14px;">
          <option value="">Todas las organizaciones</option>
        </select>
        <div class="connection-status">
          <div class="status-dot" id="connectionDot"></div>
          <span id="connectionText">Conectando...</span>
        </div>
      </div>
    </header>
    
    <div class="alert-banner" id="alertBanner">
      <div>
        <h3>üö® ¬°ALERTA ACTIVA!</h3>
        <span id="alertMessage">Temperatura fuera de rango</span>
      </div>
      <button onclick="stopAllAlerts()">üõë DETENER ALERTAS</button>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">üì° Dispositivos Online</div>
        <div class="value ok" id="devicesOnline">0</div>
      </div>
      <div class="stat-card">
        <div class="label">üå°Ô∏è Temp. Promedio</div>
        <div class="value temp" id="avgTemp">--¬∞C</div>
      </div>
      <div class="stat-card">
        <div class="label">‚ö†Ô∏è Alertas Activas</div>
        <div class="value" id="activeAlerts">0</div>
      </div>
      <div class="stat-card">
        <div class="label">üïê √öltima Actualizaci√≥n</div>
        <div class="value" id="lastUpdate" style="font-size:1.2em">--:--:--</div>
      </div>
    </div>
    
    <h2 class="section-title">üìä Dispositivos</h2>
    
    <div id="devicesContainer">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </div>
    
    <footer>
      <p>FrioSeguro ¬© 2026 - Sistema de Monitoreo de Temperatura</p>
      <p style="margin-top:8px">Datos en tiempo real via Supabase</p>
    </footer>
  </div>
  
  <script>
    // Configuraci√≥n Supabase
    const SUPABASE_URL = 'https://xhdeacnwdzvkivfjzard.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_JhTUv1X2LHMBVILUaysJ3g_Ho11zu-Q';
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let devices = [];
    let organizations = [];
    let selectedOrg = '';
    let isConnected = false;
    
    // Elementos DOM
    const connectionDot = document.getElementById('connectionDot');
    const connectionText = document.getElementById('connectionText');
    const devicesContainer = document.getElementById('devicesContainer');
    const alertBanner = document.getElementById('alertBanner');
    const alertMessage = document.getElementById('alertMessage');
    
    // Inicializar
    async function init() {
      await loadOrganizations();
      await loadDevices();
      setupRealtimeSubscription();
      setInterval(loadDevices, 5000); // Refresh cada 5 seg
    }
    
    // Cargar organizaciones
    async function loadOrganizations() {
      try {
        const { data, error } = await supabaseClient
          .from('organizations')
          .select('*')
          .order('name');
        
        if (error) throw error;
        organizations = data || [];
        
        const selector = document.getElementById('orgSelector');
        selector.innerHTML = '<option value="">Todas las organizaciones</option>' +
          organizations.map(org => `<option value="${org.slug}">${org.name}</option>`).join('');
        
      } catch (error) {
        console.error('Error loading organizations:', error);
      }
    }
    
    function changeOrg() {
      selectedOrg = document.getElementById('orgSelector').value;
      loadDevices();
    }
    
    // Cargar dispositivos
    async function loadDevices() {
      try {
        // Obtener dispositivos con su √∫ltima lectura
        let query = supabaseClient.from('devices').select('*');
        
        if (selectedOrg) {
          query = query.eq('org_slug', selectedOrg);
        }
        
        const { data: deviceData, error: deviceError } = await query.order('name');
        
        if (deviceError) throw deviceError;
        
        // Para cada dispositivo, obtener √∫ltima lectura
        const devicesWithReadings = await Promise.all(
          (deviceData || []).map(async (device) => {
            const { data: readings } = await supabaseClient
              .from('readings')
              .select('*')
              .eq('device_id', device.device_id)
              .order('created_at', { ascending: false })
              .limit(1);
            
            return {
              ...device,
              lastReading: readings?.[0] || null
            };
          })
        );
        
        devices = devicesWithReadings;
        updateUI();
        setConnected(true);
        
      } catch (error) {
        console.error('Error loading devices:', error);
        setConnected(false);
      }
    }
    
    // Suscripci√≥n realtime
    function setupRealtimeSubscription() {
      supabase
        .channel('readings-channel')
        .on('postgres_changes', 
          { event: 'INSERT', schema: 'public', table: 'readings' },
          (payload) => {
            console.log('Nueva lectura:', payload.new);
            // Actualizar dispositivo correspondiente
            const deviceIndex = devices.findIndex(d => d.device_id === payload.new.device_id);
            if (deviceIndex >= 0) {
              devices[deviceIndex].lastReading = payload.new;
              devices[deviceIndex].is_online = true;
              devices[deviceIndex].last_seen = new Date().toISOString();
              updateUI();
            }
          }
        )
        .subscribe();
      
      supabase
        .channel('alerts-channel')
        .on('postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'alerts' },
          (payload) => {
            console.log('Nueva alerta:', payload.new);
            showAlertBanner(payload.new.message);
            playAlertSound();
          }
        )
        .subscribe();
    }
    
    // Actualizar UI
    function updateUI() {
      if (devices.length === 0) {
        devicesContainer.innerHTML = `
          <div class="no-devices">
            <div class="icon">üì°</div>
            <h3>No hay dispositivos registrados</h3>
            <p>Los dispositivos aparecer√°n aqu√≠ cuando se conecten</p>
            <div style="margin-top:20px;padding:20px;background:rgba(59,130,246,0.1);border-radius:12px;text-align:left;max-width:500px;margin-left:auto;margin-right:auto;">
              <h4 style="color:#3b82f6;margin-bottom:12px;">üìã Checklist de conexi√≥n:</h4>
              <p style="color:#94a3b8;font-size:14px;line-height:1.8;">
                ‚úÖ Supabase conectado<br>
                ‚è≥ Esperando datos del ESP32...<br><br>
                <strong>Para que el ESP32 env√≠e datos:</strong><br>
                1. Conect√° el ESP32 a WiFi (via portal 192.168.4.1)<br>
                2. Verific√° que tenga internet<br>
                3. Los datos llegar√°n cada 5 segundos<br><br>
                <strong>IP del ESP32:</strong> Revis√° el Serial Monitor
              </p>
            </div>
          </div>
        `;
        return;
      }
      
      // Stats
      const online = devices.filter(d => d.is_online).length;
      const temps = devices
        .filter(d => d.lastReading?.temp_avg != null)
        .map(d => d.lastReading.temp_avg);
      const avgTemp = temps.length > 0 
        ? (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1) 
        : '--';
      const alerts = devices.filter(d => d.lastReading?.alert_active).length;
      
      document.getElementById('devicesOnline').textContent = online;
      document.getElementById('avgTemp').textContent = avgTemp + '¬∞C';
      document.getElementById('activeAlerts').textContent = alerts;
      document.getElementById('activeAlerts').className = 'value ' + (alerts > 0 ? 'critical' : 'ok');
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
      
      // Alert banner
      if (alerts > 0) {
        const alertDevice = devices.find(d => d.lastReading?.alert_active);
        showAlertBanner(`${alertDevice.name}: Temperatura ${alertDevice.lastReading?.temp_avg?.toFixed(1)}¬∞C`);
      } else {
        alertBanner.classList.remove('active');
      }
      
      // Devices grid
      devicesContainer.innerHTML = `
        <div class="devices-grid">
          ${devices.map(device => renderDeviceCard(device)).join('')}
        </div>
      `;
    }
    
    // Renderizar tarjeta de dispositivo
    function renderDeviceCard(device) {
      const r = device.lastReading;
      const temp = r?.temp_avg?.toFixed(1) || '--';
      const isOnline = device.is_online;
      const hasAlert = r?.alert_active;
      const isSimulation = r?.simulation_mode;
      
      let tempClass = '';
      if (r?.temp_avg != null) {
        if (r.temp_avg > -10) tempClass = 'critical';
        else if (r.temp_avg > -18) tempClass = 'warning';
      }
      
      let statusClass = isOnline ? 'online' : 'offline';
      let statusText = isOnline ? 'üü¢ Online' : 'üî¥ Offline';
      if (isSimulation) {
        statusClass = 'simulation';
        statusText = 'üü£ Simulaci√≥n';
      }
      
      const lastSeen = device.last_seen 
        ? new Date(device.last_seen).toLocaleTimeString()
        : '--';
      
      return `
        <div class="device-card ${hasAlert ? 'alert' : ''} ${!isOnline ? 'offline' : ''}">
          <div class="device-header">
            <div>
              <div class="device-name">‚ùÑÔ∏è ${device.name}</div>
              <div class="device-location">üìç ${device.location_detail || device.location || 'Sin ubicaci√≥n'}</div>
            </div>
            <div class="device-status ${statusClass}">${statusText}</div>
          </div>
          
          <div class="device-temp">
            <div class="temp-value ${tempClass}">${temp}¬∞C</div>
            <div class="temp-label">Temperatura actual</div>
          </div>
          
          <div class="device-info">
            <div class="info-item">
              <div class="label">üö™ Puerta</div>
              <div class="value ${r?.door_open ? 'open' : 'closed'}">
                ${r?.door_open ? 'üîì ABIERTA' : 'üîí Cerrada'}
                ${r?.door_open && r?.door_open_seconds ? ` (${Math.floor(r.door_open_seconds / 60)}m)` : ''}
              </div>
            </div>
            <div class="info-item">
              <div class="label">üîî Sirena</div>
              <div class="value">${r?.relay_on ? 'üî¥ Activa' : '‚ö´ Apagada'}</div>
            </div>
            <div class="info-item">
              <div class="label">üïê √öltima vez</div>
              <div class="value">${lastSeen}</div>
            </div>
            <div class="info-item">
              <div class="label">üì∂ Sensores</div>
              <div class="value">${r?.temp1 != null ? '‚úÖ' : '‚ùå'} S1 ${r?.temp2 != null ? '‚úÖ' : '‚ùå'} S2</div>
            </div>
          </div>
          
          ${hasAlert ? `
            <div class="device-actions">
              <button class="btn-stop" onclick="stopAlert('${device.device_id}')">üõë DETENER ALERTA</button>
            </div>
          ` : ''}
        </div>
      `;
    }
    
    // Funciones de control
    async function stopAlert(deviceId) {
      try {
        await supabaseClient.from('commands').insert({
          device_id: deviceId,
          command: 'stop_alert',
          payload: {}
        });
        alert('‚úÖ Comando enviado al dispositivo');
        loadDevices();
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al enviar comando');
      }
    }
    
    async function stopAllAlerts() {
      const alertDevices = devices.filter(d => d.lastReading?.alert_active);
      for (const device of alertDevices) {
        await stopAlert(device.device_id);
      }
    }
    
    function showAlertBanner(message) {
      alertMessage.textContent = message;
      alertBanner.classList.add('active');
    }
    
    function setConnected(connected) {
      isConnected = connected;
      connectionDot.classList.toggle('online', connected);
      connectionText.textContent = connected ? 'Conectado' : 'Desconectado';
    }
    
    function playAlertSound() {
      // Crear sonido de alerta
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      gainNode.gain.value = 0.3;
      
      oscillator.start();
      setTimeout(() => oscillator.stop(), 200);
    }
    
    // Iniciar
    init();
  </script>
</body>
</html>
